<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="John Mount, Nina Zumel" />

<meta name="date" content="2018-06-26" />

<title>vtreat package</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#header {
text-align: center;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; }  code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>

</head>

<body>




<h1 class="title toc-ignore">vtreat package</h1>
<h4 class="author"><em>John Mount, Nina Zumel</em></h4>
<h4 class="date"><em>2018-06-26</em></h4>



<p>‘vtreat’ is a data.frame processor/conditioner that prepares real-world data for predictive modeling in a statistically sound manner. A formal article on the method can be found here: <a href="https://arxiv.org/abs/1611.09477">arXiv:1611.09477 stat.AP</a>.</p>
<p>A ‘vtreat’ clean data frame:</p>
<ul>
<li>Only has numeric columns (other than the outcome).</li>
<li>Has no Infinite/NA/NaN in the effective variable columns.</li>
</ul>
<p>To achieve this a number of techniques are used. Principally:</p>
<ul>
<li><a href="http://www.win-vector.com/blog/2012/07/modeling-trick-impact-coding-of-categorical-variables-with-many-levels/">Impact coding</a></li>
<li><a href="http://www.win-vector.com/blog/2014/12/a-comment-on-preparing-data-for-classifiers/">Encoding category levels as indicators</a></li>
</ul>
<p>For more details see: <a href="http://www.win-vector.com/blog/2014/08/vtreat-designing-a-package-for-variable-treatment/">the ‘vtreat’ article</a> and <a href="http://www.win-vector.com/blog/2015/05/what-is-new-in-the-vtreat-library/">update</a>.</p>
<p>The use pattern is:</p>
<ol style="list-style-type: decimal">
<li>Use <code>designTreatmentsC()</code> or <code>designTreatmentsN()</code> to design a treatment plan</li>
<li>Use the returned structure with <code>prepare()</code> to apply the plan to data frames.</li>
</ol>
<p>The main feature of ‘vtreat’ is that all data preparation is “y-aware”: it uses the relations of effective variables to the dependent or outcome variable to encode the effective variables.</p>
<p>The structure returned from <code>designTreatmentsN()</code> or <code>designTreatmentsC()</code> includes a list of “treatments”: objects that encapsulate the transformation process from the original variables to the new “clean” variables.</p>
<p>In addition to the treatment objects <code>designTreatmentsC()</code> and <code>designTreatmentsN()</code> also return a data frame named <code>scoreFrame</code> which contains columns:</p>
<ul>
<li><code>varName</code>: name of new variable</li>
<li><code>origName</code>: name of original variable that the variable was derived from (can repeat).</li>
<li><code>code</code>: what time of treatment was performed to create the derived variable (useful for filtering).</li>
<li><code>varMoves</code>: logical TRUE if the variable varied during training; only variables that move will be in the treated frame.</li>
<li><code>sig</code>: linear significnace of regerssing derived variable against a 0/1 indicator target for numeric targets, logistic regression significance otherwise.</li>
<li><code>needsSplit</code>: is the variable a sub model and require out of sample scoring.</li>
</ul>
<p>In all cases we have two undesirable upward biases on the scores:</p>
<ul>
<li>The treated variables view the training data during construction (for setting of NA values, missing values, levels, and more). So this gives an upward bias when trying to measure treated variable utility on training data. Until the data set is at least 1000 good rows we ignore this effect. After 1000 rows we design variables on a pseudo-randomly chosen 80% of the rows and score on the complimentary 20% of the rows.</li>
<li>The scoring procedure itself involves a fit (linear regression for regression or logistic regression for classification). In each of these cases we would like the scoring itself to only be evaluated on variables constructed on held-out data. This is simulated through a cross-validation procedure.</li>
</ul>
<p>‘vtreat’ uses a number of cross-training and jackknife style procedures to try to mitigate these effects. The suggested best practice (if you have enough data) is to split your data randomly into at least the following disjoint data sets:</p>
<ul>
<li><strong>Encoding Calibration</strong> : a data set used for the <code>designTreatmentsC()</code> or <code>designTreatmentsN()</code> step and not used again for training or test.</li>
<li><strong>Training</strong> : a data set used (after <code>prepare()</code>) for training your model.</li>
<li><strong>Test</strong> : a data set used (after <code>prepare()</code>) for estimating your model’s out of training performance.</li>
</ul>
<p>Taking the extra step to perform the <code>designTreatmentsC()</code> or <code>designTreatmentsN()</code> on data disjoint from training makes the training data more exchangeable with test and avoids the issue that ‘vtreat’ may be hiding a large number of degrees of freedom in variables it derives from large categoricals.</p>
<p>Some trivial execution examples (not demonstrating any cal/train/test split) are given below. Variables that do not move during hold-out testing are considered “not to move.”</p>
<hr />
<div id="a-categorical-outcome-example" class="section level2">
<h2>A Categorical Outcome Example</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">library</span>(vtreat)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">dTrainC &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x=</span><span class="kw">c</span>(<span class="st">'a'</span>,<span class="st">'a'</span>,<span class="st">'a'</span>,<span class="st">'b'</span>,<span class="st">'b'</span>,<span class="ot">NA</span>),</a>
<a class="sourceLine" id="cb1-3" data-line-number="3">   <span class="dt">z=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="ot">NA</span>,<span class="dv">6</span>),<span class="dt">y=</span><span class="kw">c</span>(<span class="ot">FALSE</span>,<span class="ot">FALSE</span>,<span class="ot">TRUE</span>,<span class="ot">FALSE</span>,<span class="ot">TRUE</span>,<span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="kw">head</span>(dTrainC)</a></code></pre></div>
<pre><code>##      x  z     y
## 1    a  1 FALSE
## 2    a  2 FALSE
## 3    a  3  TRUE
## 4    b  4 FALSE
## 5    b NA  TRUE
## 6 &lt;NA&gt;  6  TRUE</code></pre>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">dTestC &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x=</span><span class="kw">c</span>(<span class="st">'a'</span>,<span class="st">'b'</span>,<span class="st">'c'</span>,<span class="ot">NA</span>),<span class="dt">z=</span><span class="kw">c</span>(<span class="dv">10</span>,<span class="dv">20</span>,<span class="dv">30</span>,<span class="ot">NA</span>))</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="kw">head</span>(dTestC)</a></code></pre></div>
<pre><code>##      x  z
## 1    a 10
## 2    b 20
## 3    c 30
## 4 &lt;NA&gt; NA</code></pre>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">treatmentsC &lt;-<span class="st"> </span><span class="kw">designTreatmentsC</span>(dTrainC,<span class="kw">colnames</span>(dTrainC),<span class="st">'y'</span>,<span class="ot">TRUE</span>)</a></code></pre></div>
<pre><code>## [1] &quot;vtreat 1.2.1 inspecting inputs Tue Jun 26 08:14:27 2018&quot;
## [1] &quot;designing treatments Tue Jun 26 08:14:27 2018&quot;
## [1] &quot; have initial level statistics Tue Jun 26 08:14:27 2018&quot;
## [1] &quot;design var x Tue Jun 26 08:14:27 2018&quot;
## [1] &quot;design var z Tue Jun 26 08:14:27 2018&quot;
## [1] &quot; scoring treatments Tue Jun 26 08:14:27 2018&quot;
## [1] &quot;have treatment plan Tue Jun 26 08:14:27 2018&quot;
## [1] &quot;rescoring complex variables Tue Jun 26 08:14:27 2018&quot;
## [1] &quot;done rescoring complex variables Tue Jun 26 08:14:27 2018&quot;</code></pre>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw">print</span>(treatmentsC)</a></code></pre></div>
<pre><code>##     varName varMoves        rsq       sig needsSplit extraModelDegrees
## 1    x_catP     TRUE 0.24340634 0.1547700       TRUE                 2
## 2    x_catB     TRUE 0.05070201 0.5160763       TRUE                 2
## 3   z_clean     TRUE 0.25792985 0.1429977      FALSE                 0
## 4   z_isBAD     TRUE 0.19087450 0.2076623      FALSE                 0
## 5  x_lev_NA     TRUE 0.19087450 0.2076623      FALSE                 0
## 6 x_lev_x_a     TRUE 0.08170417 0.4097258      FALSE                 0
## 7 x_lev_x_b     TRUE 0.00000000 1.0000000      FALSE                 0
##   origName  code
## 1        x  catP
## 2        x  catB
## 3        z clean
## 4        z isBAD
## 5        x   lev
## 6        x   lev
## 7        x   lev</code></pre>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw">print</span>(treatmentsC<span class="op">$</span>treatments[[<span class="dv">1</span>]])</a></code></pre></div>
<pre><code>## [1] &quot;vtreat 'Categoric Indicators'('x'(integer,factor)-&gt;character-&gt;'x_lev_NA','x_lev_x_a','x_lev_x_b')&quot;</code></pre>
<p>Here we demonstrate the optional scaling feature of <code>prepare()</code>, which scales and centers all significant variables to mean 0, and slope 1 with respect to y: In other words, it rescales the variables to “y-units”. This is useful for downstream principal components analysis. Note: variables perfectly uncorrelated with y necessarily have slope 0 and can’t be “scaled” to slope 1, however for the same reason these variables will be insignificant and can be pruned by pruneSig.</p>
<p><code>scale=FALSE</code> by default.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1">dTrainCTreated &lt;-<span class="st"> </span><span class="kw">prepare</span>(treatmentsC,dTrainC,<span class="dt">pruneSig=</span><span class="kw">c</span>(),<span class="dt">scale=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb11-2" data-line-number="2"><span class="kw">head</span>(dTrainCTreated)</a></code></pre></div>
<pre><code>##   x_catP      x_catB     z_clean z_isBAD x_lev_NA  x_lev_x_a x_lev_x_b
## 1   -0.2 -0.11976374 -0.38648649    -0.1     -0.1 -0.1666667         0
## 2   -0.2 -0.11976374 -0.21081081    -0.1     -0.1 -0.1666667         0
## 3   -0.2 -0.11976374 -0.03513514    -0.1     -0.1 -0.1666667         0
## 4    0.1 -0.07564865  0.14054054    -0.1     -0.1  0.1666667         0
## 5    0.1 -0.07564865  0.00000000     0.5     -0.1  0.1666667         0
## 6    0.4  0.51058851  0.49189189    -0.1      0.5  0.1666667         0
##       y
## 1 FALSE
## 2 FALSE
## 3  TRUE
## 4 FALSE
## 5  TRUE
## 6  TRUE</code></pre>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">varsC &lt;-<span class="st"> </span><span class="kw">setdiff</span>(<span class="kw">colnames</span>(dTrainCTreated),<span class="st">'y'</span>)</a>
<a class="sourceLine" id="cb13-2" data-line-number="2"><span class="co"># all input variables should be mean 0</span></a>
<a class="sourceLine" id="cb13-3" data-line-number="3"><span class="kw">sapply</span>(dTrainCTreated[,varsC,<span class="dt">drop=</span><span class="ot">FALSE</span>],mean)</a></code></pre></div>
<pre><code>##        x_catP        x_catB       z_clean       z_isBAD      x_lev_NA 
##  1.850372e-17  1.387779e-17  9.251859e-18 -6.938894e-18 -6.938894e-18 
##     x_lev_x_a     x_lev_x_b 
##  0.000000e+00  0.000000e+00</code></pre>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="co"># all slopes should be 1 for variables with dTrainCTreated$scoreFrame$sig&lt;1</span></a>
<a class="sourceLine" id="cb15-2" data-line-number="2"><span class="kw">sapply</span>(varsC,<span class="cf">function</span>(c) { <span class="kw">glm</span>(<span class="kw">paste</span>(<span class="st">'y'</span>,c,<span class="dt">sep=</span><span class="st">'~'</span>),<span class="dt">family=</span>binomial,</a>
<a class="sourceLine" id="cb15-3" data-line-number="3">   <span class="dt">data=</span>dTrainCTreated)<span class="op">$</span>coefficients[[<span class="dv">2</span>]]})</a></code></pre></div>
<pre><code>##    x_catP    x_catB   z_clean   z_isBAD  x_lev_NA x_lev_x_a x_lev_x_b 
##  4.698112 15.815409  5.733441 31.619223 31.619223  4.158883        NA</code></pre>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1">dTestCTreated &lt;-<span class="st"> </span><span class="kw">prepare</span>(treatmentsC,dTestC,<span class="dt">pruneSig=</span><span class="kw">c</span>(),<span class="dt">scale=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb17-2" data-line-number="2"><span class="kw">head</span>(dTestCTreated)</a></code></pre></div>
<pre><code>##   x_catP      x_catB  z_clean z_isBAD x_lev_NA  x_lev_x_a x_lev_x_b
## 1   -0.2 -0.11976374 1.194595    -0.1     -0.1 -0.1666667         0
## 2    0.1 -0.07564865 2.951351    -0.1     -0.1  0.1666667         0
## 3    0.7 -0.07564865 4.708108    -0.1     -0.1  0.1666667         0
## 4    0.4  0.51058851 0.000000     0.5      0.5  0.1666667         0</code></pre>
<hr />
</div>
<div id="a-numeric-outcome-example" class="section level2">
<h2>A Numeric Outcome Example</h2>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1"><span class="co"># numeric example</span></a>
<a class="sourceLine" id="cb19-2" data-line-number="2">dTrainN &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x=</span><span class="kw">c</span>(<span class="st">'a'</span>,<span class="st">'a'</span>,<span class="st">'a'</span>,<span class="st">'a'</span>,<span class="st">'b'</span>,<span class="st">'b'</span>,<span class="ot">NA</span>),</a>
<a class="sourceLine" id="cb19-3" data-line-number="3">   <span class="dt">z=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>,<span class="ot">NA</span>,<span class="dv">7</span>),<span class="dt">y=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>))</a>
<a class="sourceLine" id="cb19-4" data-line-number="4"><span class="kw">head</span>(dTrainN)</a></code></pre></div>
<pre><code>##   x  z y
## 1 a  1 0
## 2 a  2 0
## 3 a  3 0
## 4 a  4 1
## 5 b  5 0
## 6 b NA 1</code></pre>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1">dTestN &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x=</span><span class="kw">c</span>(<span class="st">'a'</span>,<span class="st">'b'</span>,<span class="st">'c'</span>,<span class="ot">NA</span>),<span class="dt">z=</span><span class="kw">c</span>(<span class="dv">10</span>,<span class="dv">20</span>,<span class="dv">30</span>,<span class="ot">NA</span>))</a>
<a class="sourceLine" id="cb21-2" data-line-number="2"><span class="kw">head</span>(dTestN)</a></code></pre></div>
<pre><code>##      x  z
## 1    a 10
## 2    b 20
## 3    c 30
## 4 &lt;NA&gt; NA</code></pre>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1">treatmentsN =<span class="st"> </span><span class="kw">designTreatmentsN</span>(dTrainN,<span class="kw">colnames</span>(dTrainN),<span class="st">'y'</span>)</a></code></pre></div>
<pre><code>## [1] &quot;vtreat 1.2.1 inspecting inputs Tue Jun 26 08:14:27 2018&quot;
## [1] &quot;designing treatments Tue Jun 26 08:14:27 2018&quot;
## [1] &quot; have initial level statistics Tue Jun 26 08:14:27 2018&quot;
## [1] &quot;design var x Tue Jun 26 08:14:27 2018&quot;
## [1] &quot;design var z Tue Jun 26 08:14:27 2018&quot;
## [1] &quot; scoring treatments Tue Jun 26 08:14:27 2018&quot;
## [1] &quot;have treatment plan Tue Jun 26 08:14:27 2018&quot;
## [1] &quot;rescoring complex variables Tue Jun 26 08:14:27 2018&quot;
## [1] &quot;done rescoring complex variables Tue Jun 26 08:14:28 2018&quot;</code></pre>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1"><span class="kw">print</span>(treatmentsN)</a></code></pre></div>
<pre><code>##     varName varMoves         rsq       sig needsSplit extraModelDegrees
## 1    x_catP     TRUE 0.260416667 0.2419189       TRUE                 2
## 2    x_catN     TRUE 0.069728569 0.5671793       TRUE                 2
## 3    x_catD     TRUE 0.005613741 0.8731603       TRUE                 2
## 4   z_clean     TRUE 0.336111111 0.1724763      FALSE                 0
## 5   z_isBAD     TRUE 0.222222222 0.2855909      FALSE                 0
## 6  x_lev_NA     TRUE 0.222222222 0.2855909      FALSE                 0
## 7 x_lev_x_a     TRUE 0.173611111 0.3524132      FALSE                 0
## 8 x_lev_x_b     TRUE 0.008333333 0.8456711      FALSE                 0
##   origName  code
## 1        x  catP
## 2        x  catN
## 3        x  catD
## 4        z clean
## 5        z isBAD
## 6        x   lev
## 7        x   lev
## 8        x   lev</code></pre>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" data-line-number="1">dTrainNTreated &lt;-<span class="st"> </span><span class="kw">prepare</span>(treatmentsN,dTrainN,</a>
<a class="sourceLine" id="cb27-2" data-line-number="2">                          <span class="dt">pruneSig=</span><span class="kw">c</span>(),<span class="dt">scale=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb27-3" data-line-number="3"><span class="kw">head</span>(dTrainNTreated)</a></code></pre></div>
<pre><code>##   x_catP      x_catN     x_catD     z_clean    z_isBAD   x_lev_NA
## 1   -0.2 -0.17857143 -0.1785714 -0.41904762 -0.0952381 -0.0952381
## 2   -0.2 -0.17857143 -0.1785714 -0.26190476 -0.0952381 -0.0952381
## 3   -0.2 -0.17857143 -0.1785714 -0.10476190 -0.0952381 -0.0952381
## 4   -0.2 -0.17857143 -0.1785714  0.05238095 -0.0952381 -0.0952381
## 5    0.2  0.07142857  0.2380952  0.20952381 -0.0952381 -0.0952381
## 6    0.2  0.07142857  0.2380952  0.00000000  0.5714286 -0.0952381
##    x_lev_x_a   x_lev_x_b y
## 1 -0.1785714 -0.02857143 0
## 2 -0.1785714 -0.02857143 0
## 3 -0.1785714 -0.02857143 0
## 4 -0.1785714 -0.02857143 1
## 5  0.2380952  0.07142857 0
## 6  0.2380952  0.07142857 1</code></pre>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" data-line-number="1">varsN &lt;-<span class="st"> </span><span class="kw">setdiff</span>(<span class="kw">colnames</span>(dTrainNTreated),<span class="st">'y'</span>)</a>
<a class="sourceLine" id="cb29-2" data-line-number="2"><span class="co"># all input variables should be mean 0</span></a>
<a class="sourceLine" id="cb29-3" data-line-number="3"><span class="kw">sapply</span>(dTrainNTreated[,varsN,<span class="dt">drop=</span><span class="ot">FALSE</span>],mean) </a></code></pre></div>
<pre><code>##        x_catP        x_catN        x_catD       z_clean       z_isBAD 
## -5.551115e-17 -3.965082e-18 -9.515810e-17  4.757324e-17 -3.967986e-18 
##      x_lev_NA     x_lev_x_a     x_lev_x_b 
## -3.965082e-18  0.000000e+00 -2.974054e-18</code></pre>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" data-line-number="1"><span class="co"># all slopes should be 1 for variables with treatmentsN$scoreFrame$sig&lt;1</span></a>
<a class="sourceLine" id="cb31-2" data-line-number="2"><span class="kw">sapply</span>(varsN,<span class="cf">function</span>(c) { <span class="kw">lm</span>(<span class="kw">paste</span>(<span class="st">'y'</span>,c,<span class="dt">sep=</span><span class="st">'~'</span>),</a>
<a class="sourceLine" id="cb31-3" data-line-number="3">   <span class="dt">data=</span>dTrainNTreated)<span class="op">$</span>coefficients[[<span class="dv">2</span>]]}) </a></code></pre></div>
<pre><code>##    x_catP    x_catN    x_catD   z_clean   z_isBAD  x_lev_NA x_lev_x_a 
##         1         1         1         1         1         1         1 
## x_lev_x_b 
##         1</code></pre>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" data-line-number="1"><span class="co"># prepared frame</span></a>
<a class="sourceLine" id="cb33-2" data-line-number="2">dTestNTreated &lt;-<span class="st"> </span><span class="kw">prepare</span>(treatmentsN,dTestN,</a>
<a class="sourceLine" id="cb33-3" data-line-number="3">                         <span class="dt">pruneSig=</span><span class="kw">c</span>())</a>
<a class="sourceLine" id="cb33-4" data-line-number="4"><span class="kw">head</span>(dTestNTreated)</a></code></pre></div>
<pre><code>##      x_catP      x_catN    x_catD   z_clean z_isBAD x_lev_NA x_lev_x_a
## 1 0.5714286 -0.17857143 0.5000000 10.000000       0        0         1
## 2 0.2857143  0.07142857 0.7071068 20.000000       0        0         0
## 3 0.0000000  0.00000000 0.7071068 30.000000       0        0         0
## 4 0.1428571  0.57142857 0.7071068  3.666667       1        1         0
##   x_lev_x_b
## 1         0
## 2         1
## 3         0
## 4         0</code></pre>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" data-line-number="1"><span class="co"># scaled prepared frame</span></a>
<a class="sourceLine" id="cb35-2" data-line-number="2">dTestNTreatedS &lt;-<span class="st"> </span><span class="kw">prepare</span>(treatmentsN,dTestN,</a>
<a class="sourceLine" id="cb35-3" data-line-number="3">                         <span class="dt">pruneSig=</span><span class="kw">c</span>(),<span class="dt">scale=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb35-4" data-line-number="4"><span class="kw">head</span>(dTestNTreatedS)</a></code></pre></div>
<pre><code>##   x_catP        x_catN     x_catD   z_clean    z_isBAD   x_lev_NA
## 1   -0.2 -1.785714e-01 -0.1785714 0.9952381 -0.0952381 -0.0952381
## 2    0.2  7.142857e-02  0.2380952 2.5666667 -0.0952381 -0.0952381
## 3    0.6 -1.586033e-17  0.2380952 4.1380952 -0.0952381 -0.0952381
## 4    0.4  5.714286e-01  0.2380952 0.0000000  0.5714286  0.5714286
##    x_lev_x_a   x_lev_x_b
## 1 -0.1785714 -0.02857143
## 2  0.2380952  0.07142857
## 3  0.2380952 -0.02857143
## 4  0.2380952 -0.02857143</code></pre>
<p>Related work:</p>
<ul>
<li><em>Applied Multiple Regression/Correlation Analysis for the Behavioral Sciences</em>, 2nd edition, 1983, Jacob Cohen, Patricia Cohen (called the concept “effects coded variables”).</li>
<li><a href="http://dl.acm.org/citation.cfm?id=507538">“A preprocessing scheme for high-cardinality categorical attributes in classification and prediction problems”</a> Daniele Micci-Barreca, ACM SIGKDD Explorations, Volume 3 Issue 1, July 2001 Pages 27-32.</li>
<li><a href="http://www.win-vector.com/blog/2012/07/modeling-trick-impact-coding-of-categorical-variables-with-many-levels/">“Modeling Trick: Impact Coding of Categorical Variables with Many Levels”</a> Nina Zumel, Win-Vector blog, 2012.</li>
<li><a href="https://blogs.technet.microsoft.com/machinelearning/2015/02/17/big-learning-made-easy-with-counts/">“Big Learning Made Easy – with Counts!”</a>, Misha Bilenko, Cortana Intelligence and Machine Learning Blog, 2015.</li>
</ul>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
