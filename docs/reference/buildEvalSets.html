<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Build set carve-up for out-of sample evaluation. — buildEvalSets • vtreat</title>


<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Build set carve-up for out-of sample evaluation. — buildEvalSets" />
<meta property="og:description" content="Return a carve-up of seq_len(nRows).  Very useful for any sort of
nested model situation (such as data prep, stacking, or super-learning)." />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">vtreat</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.6.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/vtreat.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="../articles/MultiClassVtreat.html">Multi Class vtreat</a>
    </li>
    <li>
      <a href="../articles/SavingTreamentPlans.html">Saving Treatment Plans</a>
    </li>
    <li>
      <a href="../articles/VariableImportance.html">vtreat Variable Importance</a>
    </li>
    <li>
      <a href="../articles/vtreatCrossFrames.html">vtreat cross frames</a>
    </li>
    <li>
      <a href="../articles/vtreatGrouping.html">vtreat grouping example</a>
    </li>
    <li>
      <a href="../articles/vtreatOverfit.html">vtreat overfit</a>
    </li>
    <li>
      <a href="../articles/vtreatRareLevels.html">vtreat Rare Levels</a>
    </li>
    <li>
      <a href="../articles/vtreatScaleMode.html">vtreat scale mode</a>
    </li>
    <li>
      <a href="../articles/vtreatSignificance.html">vtreat significance</a>
    </li>
    <li>
      <a href="../articles/vtreatSplitting.html">vtreat data splitting</a>
    </li>
    <li>
      <a href="../articles/vtreatVariableTypes.html">Variable Types</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://win-vector.com/">Sponsor: Win-Vector LLC</a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Build set carve-up for out-of sample evaluation.</h1>
    <small class="dont-index">Source: <a href='https://github.com/WinVector/vtreat/blob/master/R/outOfSample.R'><code>R/outOfSample.R</code></a></small>
    <div class="hidden name"><code>buildEvalSets.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Return a carve-up of seq_len(nRows).  Very useful for any sort of
nested model situation (such as data prep, stacking, or super-learning).</p>
    </div>

    <pre class="usage"><span class='fu'>buildEvalSets</span><span class='op'>(</span>
  <span class='va'>nRows</span>,
  <span class='va'>...</span>,
  dframe <span class='op'>=</span> <span class='cn'>NULL</span>,
  y <span class='op'>=</span> <span class='cn'>NULL</span>,
  splitFunction <span class='op'>=</span> <span class='cn'>NULL</span>,
  nSplits <span class='op'>=</span> <span class='fl'>3</span>
<span class='op'>)</span></pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>nRows</th>
      <td><p>scalar, &gt;=1 number of rows to sample from.</p></td>
    </tr>
    <tr>
      <th>...</th>
      <td><p>no additional arguments, declared to forced named binding of later arguments.</p></td>
    </tr>
    <tr>
      <th>dframe</th>
      <td><p>(optional) original data.frame, passed to user splitFunction.</p></td>
    </tr>
    <tr>
      <th>y</th>
      <td><p>(optional) numeric vector, outcome variable (possibly to stratify on), passed to user splitFunction.</p></td>
    </tr>
    <tr>
      <th>splitFunction</th>
      <td><p>(optional) function taking arguments nSplits,nRows,dframe, and y; returning a user desired split.</p></td>
    </tr>
    <tr>
      <th>nSplits</th>
      <td><p>integer, target number of splits.</p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>list of lists where the app portion of the sub-lists is a disjoint carve-up of seq_len(nRows) and each list as a train portion disjoint from app.</p>
    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p>Also sets attribute "splitmethod" on return value that describes how the split was performed.
attr(returnValue,'splitmethod') is one of: 'notsplit' (data was not split; corner cases
like single row data sets), 'oneway' (leave one out holdout), 'kwaycross' (a simple
partition), 'userfunction' (user supplied function was actually used), or a user specified attribute.
Any user
desired properties (such as stratification on y, or preservation of groups designated by 
original data row numbers) may not apply unless you see that 'userfunction' has been
used.</p>
<p>The intent is the user splitFunction only needs to handle "easy cases" 
and maintain user invariants. If the user splitFunction returns NULL,
throws, or returns an unacceptable carve-up then vtreat::buildEvalSets
returns its own eval set plan.  The signature of splitFunction should
be splitFunction(nRows,nSplits,dframe,y) where nSplits is the number of 
pieces we want in the carve-up, nRows is the number of rows to split,
dframe is the original dataframe (useful for any group control variables),
and y is a numeric vector representing outcome (useful for outcome stratification).</p>
<p>Note that buildEvalSets may not always return a partition (such
as one row dataframes), or if the user split function chooses to make rows eligible for
application a different number of times.</p>
    <h2 class="hasAnchor" id="see-also"><a class="anchor" href="#see-also"></a>See also</h2>

    <div class='dont-index'><p><code><a href='kWayCrossValidation.html'>kWayCrossValidation</a></code>, <code><a href='kWayStratifiedY.html'>kWayStratifiedY</a></code>, and <code><a href='makekWayCrossValidationGroupedByColumn.html'>makekWayCrossValidationGroupedByColumn</a></code></p></div>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'>
<span class='co'># use</span>
<span class='fu'>buildEvalSets</span><span class='op'>(</span><span class='fl'>200</span><span class='op'>)</span>
</div><div class='output co'>#&gt; [[1]]
#&gt; [[1]]$train
#&gt;   [1]   1   3   4   5   6   7   8   9  10  11  15  17  18  21  23  24  25  26
#&gt;  [19]  27  28  29  30  31  32  33  34  39  41  42  43  45  46  48  49  50  51
#&gt;  [37]  52  54  55  56  61  62  64  65  66  67  68  69  70  73  74  75  76  77
#&gt;  [55]  80  81  82  84  85  86  87  88  90  91  92  94  95  98 100 101 103 104
#&gt;  [73] 108 109 110 111 112 113 114 115 116 117 119 120 122 125 126 129 130 131
#&gt;  [91] 132 133 139 140 141 142 143 144 146 147 149 150 152 154 155 158 159 160
#&gt; [109] 162 164 165 166 167 168 170 173 174 175 176 180 181 182 183 184 185 186
#&gt; [127] 187 188 189 190 191 193 198 200
#&gt; 
#&gt; [[1]]$app
#&gt;  [1]  40  44  58 102  37  83 145  89 177  79 179 135  12  72  71 124  57  16 107
#&gt; [20]  60 138 118  63 199  19  78 169 197 153  14 196 178  53 127 148 151  97 161
#&gt; [39]  96 105 195  20  22 134 156 192 171 106  93  59 121  47  38 123 128  35 136
#&gt; [58] 157 172 137   2 194  13  36  99 163
#&gt; 
#&gt; 
#&gt; [[2]]
#&gt; [[2]]$train
#&gt;   [1]   2   5   9  11  12  13  14  15  16  18  19  20  22  24  27  33  34  35
#&gt;  [19]  36  37  38  40  41  42  44  46  47  49  51  52  53  55  57  58  59  60
#&gt;  [37]  62  63  64  65  66  71  72  73  74  75  76  77  78  79  83  85  89  90
#&gt;  [55]  93  94  95  96  97  99 100 101 102 103 104 105 106 107 109 114 115 116
#&gt;  [73] 118 120 121 123 124 125 127 128 129 130 131 132 133 134 135 136 137 138
#&gt;  [91] 141 143 144 145 148 150 151 152 153 155 156 157 158 159 160 161 162 163
#&gt; [109] 165 166 169 171 172 174 175 177 178 179 180 181 185 186 187 188 192 193
#&gt; [127] 194 195 196 197 198 199 200
#&gt; 
#&gt; [[2]]$app
#&gt;  [1] 139 113 182  29 142 108  56  31  10 191  23  54  92   3 140  26 117  43  87
#&gt; [20]  32  25 149 111 184  50  84  98   6  88  86  67 164  39 112 147 173 146 168
#&gt; [39]  17  48  69 170   4  21  28   7 119   8 122 176  82  61  68 110 183  91 167
#&gt; [58] 154 189  80  30 126 190  70   1  45  81
#&gt; 
#&gt; 
#&gt; [[3]]
#&gt; [[3]]$train
#&gt;   [1]   1   2   3   4   6   7   8  10  12  13  14  16  17  19  20  21  22  23
#&gt;  [19]  25  26  28  29  30  31  32  35  36  37  38  39  40  43  44  45  47  48
#&gt;  [37]  50  53  54  56  57  58  59  60  61  63  67  68  69  70  71  72  78  79
#&gt;  [55]  80  81  82  83  84  86  87  88  89  91  92  93  96  97  98  99 102 105
#&gt;  [73] 106 107 108 110 111 112 113 117 118 119 121 122 123 124 126 127 128 134
#&gt;  [91] 135 136 137 138 139 140 142 145 146 147 148 149 151 153 154 156 157 161
#&gt; [109] 163 164 167 168 169 170 171 172 173 176 177 178 179 182 183 184 189 190
#&gt; [127] 191 192 194 195 196 197 199
#&gt; 
#&gt; [[3]]$app
#&gt;  [1]  42  15  85  74  66 132  52  24  73  49 101 198 104 144 187  64 130  33 143
#&gt; [20]  65 125 116 141  34 186  94 152  51 166 159  18 180  90 155 165 158  77 100
#&gt; [39] 131 109 162 181  62  46 114 188   5  11 193  55 120 185 133  95 200 150  76
#&gt; [58] 175   9 160  75 115  27 129  41 174 103
#&gt; 
#&gt; 
#&gt; attr(,"splitmethod")
#&gt; [1] "kwaycross"</div><div class='input'>
<span class='co'># longer example</span>
<span class='co'># helper fns</span>
<span class='co'># fit models using experiment plan to estimate out of sample behavior</span>
<span class='va'>fitModelAndApply</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>trainData</span>,<span class='va'>applicaitonData</span><span class='op'>)</span> <span class='op'>{</span>
   <span class='va'>model</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/lm.html'>lm</a></span><span class='op'>(</span><span class='va'>y</span><span class='op'>~</span><span class='va'>x</span>,data<span class='op'>=</span><span class='va'>trainData</span><span class='op'>)</span>
   <span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span><span class='op'>(</span><span class='va'>model</span>,newdata<span class='op'>=</span><span class='va'>applicaitonData</span><span class='op'>)</span>
<span class='op'>}</span>
<span class='va'>simulateOutOfSampleTrainEval</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>d</span>,<span class='va'>fitApplyFn</span><span class='op'>)</span> <span class='op'>{</span>
   <span class='va'>eSets</span> <span class='op'>&lt;-</span> <span class='fu'>buildEvalSets</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>d</span><span class='op'>)</span><span class='op'>)</span>
   <span class='va'>evals</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/lapply.html'>lapply</a></span><span class='op'>(</span><span class='va'>eSets</span>, 
      <span class='kw'>function</span><span class='op'>(</span><span class='va'>ei</span><span class='op'>)</span> <span class='op'>{</span> <span class='fu'>fitApplyFn</span><span class='op'>(</span><span class='va'>d</span><span class='op'>[</span><span class='va'>ei</span><span class='op'>$</span><span class='va'>train</span>,<span class='op'>]</span>,<span class='va'>d</span><span class='op'>[</span><span class='va'>ei</span><span class='op'>$</span><span class='va'>app</span>,<span class='op'>]</span><span class='op'>)</span> <span class='op'>}</span><span class='op'>)</span>
   <span class='va'>pred</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/numeric.html'>numeric</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>d</span><span class='op'>)</span><span class='op'>)</span>
   <span class='kw'>for</span><span class='op'>(</span><span class='va'>eii</span> <span class='kw'>in</span> <span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq_len</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/length.html'>length</a></span><span class='op'>(</span><span class='va'>eSets</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>{</span>
     <span class='va'>pred</span><span class='op'>[</span><span class='va'>eSets</span><span class='op'>[[</span><span class='va'>eii</span><span class='op'>]</span><span class='op'>]</span><span class='op'>$</span><span class='va'>app</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='va'>evals</span><span class='op'>[[</span><span class='va'>eii</span><span class='op'>]</span><span class='op'>]</span>
   <span class='op'>}</span>
   <span class='va'>pred</span>
<span class='op'>}</span>

<span class='co'># run the experiment</span>
<span class='fu'><a href='https://rdrr.io/r/base/Random.html'>set.seed</a></span><span class='op'>(</span><span class='fl'>2352356</span><span class='op'>)</span>
<span class='co'># example data</span>
<span class='va'>d</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span>x<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span><span class='op'>(</span><span class='fl'>5</span><span class='op'>)</span>,y<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span><span class='op'>(</span><span class='fl'>5</span><span class='op'>)</span>,
        outOfSampleEst<span class='op'>=</span><span class='cn'>NA</span>,inSampleEst<span class='op'>=</span><span class='cn'>NA</span><span class='op'>)</span>
        
<span class='co'># fit model on all data</span>
<span class='va'>d</span><span class='op'>$</span><span class='va'>inSampleEst</span> <span class='op'>&lt;-</span> <span class='fu'>fitModelAndApply</span><span class='op'>(</span><span class='va'>d</span>,<span class='va'>d</span><span class='op'>)</span>
<span class='co'># compute in-sample R^2 (above zero, falsely shows a </span>
<span class='co'>#   relation until we adjust for degrees of freedom)</span>
<span class='fl'>1</span><span class='op'>-</span><span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='op'>(</span><span class='va'>d</span><span class='op'>$</span><span class='va'>y</span><span class='op'>-</span><span class='va'>d</span><span class='op'>$</span><span class='va'>inSampleEst</span><span class='op'>)</span><span class='op'>^</span><span class='fl'>2</span><span class='op'>)</span><span class='op'>/</span><span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='op'>(</span><span class='va'>d</span><span class='op'>$</span><span class='va'>y</span><span class='op'>-</span><span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>d</span><span class='op'>$</span><span class='va'>y</span><span class='op'>)</span><span class='op'>)</span><span class='op'>^</span><span class='fl'>2</span><span class='op'>)</span>
</div><div class='output co'>#&gt; [1] 0.4193942</div><div class='input'>
<span class='va'>d</span><span class='op'>$</span><span class='va'>outOfSampleEst</span> <span class='op'>&lt;-</span> <span class='fu'>simulateOutOfSampleTrainEval</span><span class='op'>(</span><span class='va'>d</span>,<span class='va'>fitModelAndApply</span><span class='op'>)</span>
<span class='co'># compute out-sample R^2 (not positive, </span>
<span class='co'>#  evidence of no relation)</span>
<span class='fl'>1</span><span class='op'>-</span><span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='op'>(</span><span class='va'>d</span><span class='op'>$</span><span class='va'>y</span><span class='op'>-</span><span class='va'>d</span><span class='op'>$</span><span class='va'>outOfSampleEst</span><span class='op'>)</span><span class='op'>^</span><span class='fl'>2</span><span class='op'>)</span><span class='op'>/</span><span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='op'>(</span><span class='va'>d</span><span class='op'>$</span><span class='va'>y</span><span class='op'>-</span><span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>d</span><span class='op'>$</span><span class='va'>y</span><span class='op'>)</span><span class='op'>)</span><span class='op'>^</span><span class='fl'>2</span><span class='op'>)</span>
</div><div class='output co'>#&gt; [1] -3.873148</div><div class='input'>
</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by John Mount, Nina Zumel.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


