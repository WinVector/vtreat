<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Grouping Example • vtreat</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">vtreat</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="..//index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/vtreat.html">Get Started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/SavingTreamentPlans.html">Saving Treatment Plans</a>
    </li>
    <li>
      <a href="../articles/vtreatCrossFrames.html">vtreat cross frames</a>
    </li>
    <li>
      <a href="../articles/vtreatGrouping.html">Grouping Example</a>
    </li>
    <li>
      <a href="../articles/vtreatOverfit.html">vtreat overfit</a>
    </li>
    <li>
      <a href="../articles/vtreatRareLevels.html">vtreat Rare Levels</a>
    </li>
    <li>
      <a href="../articles/vtreatScaleMode.html">vtreat scale mode</a>
    </li>
    <li>
      <a href="../articles/vtreatSignificance.html">vtreat significance</a>
    </li>
    <li>
      <a href="../articles/vtreatSplitting.html">vtreat splitting</a>
    </li>
    <li>
      <a href="../articles/vtreatVariableTypes.html">Variable Types</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/WinVector/vtreat/">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Grouping Example</h1>
                        <h4 class="author">Nina Zumel, Nate Sutton</h4>
            
            <h4 class="date">2017-07-31</h4>
          </div>

    
    
<div class="contents">
<p>This vignette shows an example use of <em>y</em>-stratified sampling with a grouping restriction in <code>vtreat</code>.</p>
<p>For this example, we will use the <code>Theosph</code> dataset: data from an experiment on the pharmacokinetics of theophylline. We will demonstrate the desired effects of <em>y</em>-stratification while also respecting a grouping constraint.</p>
<div id="the-data" class="section level2">
<h2 class="hasAnchor">
<a href="#the-data" class="anchor"></a>The Data</h2>
<p>First, let’s look at the data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># panel data for concentration in multiple subjects </span>
d &lt;-<span class="st"> </span>datasets::Theoph
<span class="kw">head</span>(d)</code></pre></div>
<pre><code>##   Subject   Wt Dose Time  conc
## 1       1 79.6 4.02 0.00  0.74
## 2       1 79.6 4.02 0.25  2.84
## 3       1 79.6 4.02 0.57  6.57
## 4       1 79.6 4.02 1.12 10.50
## 5       1 79.6 4.02 2.02  9.66
## 6       1 79.6 4.02 3.82  8.58</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(d)</code></pre></div>
<pre><code>##     Subject         Wt             Dose            Time       
##  6      :11   Min.   :54.60   Min.   :3.100   Min.   : 0.000  
##  7      :11   1st Qu.:63.58   1st Qu.:4.305   1st Qu.: 0.595  
##  8      :11   Median :70.50   Median :4.530   Median : 3.530  
##  11     :11   Mean   :69.58   Mean   :4.626   Mean   : 5.895  
##  3      :11   3rd Qu.:74.42   3rd Qu.:5.037   3rd Qu.: 9.000  
##  2      :11   Max.   :86.40   Max.   :5.860   Max.   :24.650  
##  (Other):66                                                   
##       conc       
##  Min.   : 0.000  
##  1st Qu.: 2.877  
##  Median : 5.275  
##  Mean   : 4.960  
##  3rd Qu.: 7.140  
##  Max.   :11.400  
## </code></pre>
<p>We have twelve subjects, who each received a dose of the anti-asthma drug theophylline. The theophylline concentration in the patients’ blood was then measured at eleven points during the next 25 hours. Most of the patients got about the same dose, although the dose information reported in the dataset is normalized by weight.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">if(have_ggplot) {
  <span class="kw">ggplot</span>(d, <span class="kw">aes</span>(<span class="dt">x=</span>Time, <span class="dt">y=</span>conc, <span class="dt">color=</span>Subject)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_point</span>() +<span class="st"> </span><span class="kw">geom_line</span>() +<span class="st"> </span>
<span class="st">    </span><span class="kw">theme</span>(<span class="dt">legend.position=</span><span class="st">"none"</span>) +<span class="st"> </span>
<span class="st">    </span><span class="kw">ggtitle</span>(<span class="st">"Theophylline concentrations over time"</span>)
}</code></pre></div>
<p><img src="vtreatGrouping_files/figure-html/unnamed-chunk-3-1.png" width="672"></p>
</div>
<div id="partitioning-the-data-for-modeling" class="section level2">
<h2 class="hasAnchor">
<a href="#partitioning-the-data-for-modeling" class="anchor"></a>Partitioning the Data for Modeling</h2>
<p>Suppose we wanted to fit a model to analyze how a patient’s weight affects how theophylline is metabolized, and validate that model with three-fold cross-validation. It would be important that all readings from a given patient stay in the same fold. We might also want the population in each fold to have similar distributions of theophylline concentrations curves.</p>
<p>Recall that the goal of <em>y</em>-stratification is to insure that all samples from the data have as close to identical <em>y</em> distributions as possible. This becomes more difficult when we also have to obey a grouping constraint.</p>
<p>Let’s look at three ways of splitting the data into folds. First, we will split the data arbitrarily into three groups, using the modulo of the Subject id to do the splitting.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># a somewhat arbitrary split of patients</span>
subnum =<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">as.character</span>(d$Subject))
d$modSplit =<span class="st"> </span><span class="kw">as.factor</span>(subnum %%<span class="st"> </span><span class="dv">3</span>)</code></pre></div>
<p>We can verify that this split preserves groups, by looking at the table of subject observations in each fold. Each subject should only appear in a single fold.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">print</span>(<span class="kw">table</span>(<span class="dt">Subject=</span>d$Subject, <span class="dt">groupid=</span>d$modSplit))</code></pre></div>
<pre><code>##        groupid
## Subject  0  1  2
##      6  11  0  0
##      7   0 11  0
##      8   0  0 11
##      11  0  0 11
##      3  11  0  0
##      2   0  0 11
##      4   0 11  0
##      9  11  0  0
##      12 11  0  0
##      10  0 11  0
##      1   0 11  0
##      5   0  0 11</code></pre>
<p>Now let’s try the standard <em>y</em> stratification in <code>vtreat</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># stratify by outcome only</span>
<span class="co"># forces concentration to be equivalent</span>
pStrat &lt;-<span class="st"> </span><span class="kw"><a href="../reference/kWayStratifiedY.html">kWayStratifiedY</a></span>(<span class="kw">nrow</span>(d),<span class="dv">3</span>,d,d$conc)
<span class="kw">attr</span>(pStrat, <span class="st">"splitmethod"</span>)</code></pre></div>
<pre><code>## [1] "kwaycrossystratified"</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">d$stratSplit &lt;-<span class="st"> </span>vtreat::<span class="kw"><a href="../reference/getSplitPlanAppLabels.html">getSplitPlanAppLabels</a></span>(<span class="kw">nrow</span>(d),pStrat)

<span class="kw">print</span>(<span class="kw">table</span>(<span class="dt">Subject=</span>d$Subject, <span class="dt">groupid=</span>d$stratSplit))</code></pre></div>
<pre><code>##        groupid
## Subject 1 2 3
##      6  4 4 3
##      7  4 6 1
##      8  3 4 4
##      11 1 5 5
##      3  3 2 6
##      2  5 2 4
##      4  3 3 5
##      9  5 4 2
##      12 3 4 4
##      10 6 2 3
##      1  2 5 4
##      5  5 3 3</code></pre>
<p>We can see this partition didn’t preserve the <code>Subject</code> grouping.</p>
<p>Finally, we can try <code>vtreat</code>’s group-preserving split, which also tries to <em>y</em>-stratify as much as possible (by stratifying on the mean <em>y</em> observation from each group).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># stratify by patient and outcome</span>
<span class="co"># allows concentration to vary amoung individual patients</span>
splitter &lt;-<span class="st"> </span><span class="kw"><a href="../reference/makekWayCrossValidationGroupedByColumn.html">makekWayCrossValidationGroupedByColumn</a></span>(<span class="st">'Subject'</span>)
split &lt;-<span class="st"> </span><span class="kw">splitter</span>(<span class="kw">nrow</span>(d),<span class="dv">3</span>,d,d$conc)
<span class="kw">attr</span>(split, <span class="st">"splitmethod"</span>)</code></pre></div>
<pre><code>## [1] "kwaycrossystratifiedgrouped"</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">d$subjectSplit &lt;-<span class="st"> </span>vtreat::<span class="kw"><a href="../reference/getSplitPlanAppLabels.html">getSplitPlanAppLabels</a></span>(<span class="kw">nrow</span>(d),split)

<span class="kw">print</span>(<span class="kw">table</span>(<span class="dt">Subject=</span>d$Subject, <span class="dt">groupid=</span>d$subjectSplit))</code></pre></div>
<pre><code>##        groupid
## Subject  1  2  3
##      6  11  0  0
##      7   0  0 11
##      8   0 11  0
##      11  0 11  0
##      3  11  0  0
##      2   0  0 11
##      4   0 11  0
##      9  11  0  0
##      12  0  0 11
##      10 11  0  0
##      1   0 11  0
##      5   0  0 11</code></pre>
<p>This is again a subject-preserving partition.</p>
<p>We can compare the mean theophylline concentration and the average pharmacokinetic profile for each fold, for both of the subject-preserving partitions. We see that the stratification reduces some of the variation between folds.</p>
<div id="arbitrary-partition" class="section level3">
<h3 class="hasAnchor">
<a href="#arbitrary-partition" class="anchor"></a>Arbitrary Partition</h3>
<pre><code>## [1] "Arbitrary grouping"
## [1] "Group means:"
##        0        1        2 
## 4.728864 5.305227 4.847273 
## [1] "Standard deviation of group means: 0.304395061237506"</code></pre>
<p><img src="vtreatGrouping_files/figure-html/unnamed-chunk-8-1.png" width="672"></p>
</div>
<div id="group-preserving-y-stratified-partition" class="section level3">
<h3 class="hasAnchor">
<a href="#group-preserving-y-stratified-partition" class="anchor"></a>Group-preserving, <em>y</em>-stratified Partition</h3>
<pre><code>## [1] "Group by patient, stratify on y"
## [1] "Group means:"
##        1        2        3 
## 4.859091 5.040455 4.981818 
## [1] "Standard deviation of group means: 0.0925499641694611"</code></pre>
<p><img src="vtreatGrouping_files/figure-html/unnamed-chunk-9-1.png" width="672"></p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#the-data">The Data</a></li>
      <li><a href="#partitioning-the-data-for-modeling">Partitioning the Data for Modeling</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by John Mount, Nina Zumel.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
