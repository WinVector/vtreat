<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>vtreat grouping example • vtreat</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="vtreat grouping example">
<meta property="og:description" content="vtreat">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">vtreat</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.6.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/vtreat.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/MultiClassVtreat.html">Multi Class vtreat</a>
    </li>
    <li>
      <a href="../articles/SavingTreamentPlans.html">Saving Treatment Plans</a>
    </li>
    <li>
      <a href="../articles/VariableImportance.html">vtreat Variable Importance</a>
    </li>
    <li>
      <a href="../articles/vtreatCrossFrames.html">vtreat cross frames</a>
    </li>
    <li>
      <a href="../articles/vtreatGrouping.html">vtreat grouping example</a>
    </li>
    <li>
      <a href="../articles/vtreatOverfit.html">vtreat overfit</a>
    </li>
    <li>
      <a href="../articles/vtreatRareLevels.html">vtreat Rare Levels</a>
    </li>
    <li>
      <a href="../articles/vtreatScaleMode.html">vtreat scale mode</a>
    </li>
    <li>
      <a href="../articles/vtreatSignificance.html">vtreat significance</a>
    </li>
    <li>
      <a href="../articles/vtreatSplitting.html">vtreat data splitting</a>
    </li>
    <li>
      <a href="../articles/vtreatVariableTypes.html">Variable Types</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://win-vector.com/">Sponsor: Win-Vector LLC</a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="vtreatGrouping_files/header-attrs-2.7/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>vtreat grouping example</h1>
                        <h4 class="author">Nina Zumel, Nate Sutton</h4>
            
            <h4 class="date">2021-04-21</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/WinVector/vtreat/blob/master/vignettes/vtreatGrouping.Rmd"><code>vignettes/vtreatGrouping.Rmd</code></a></small>
      <div class="hidden name"><code>vtreatGrouping.Rmd</code></div>

    </div>

    
    
<p>This vignette shows an example use of <em>y</em>-stratified sampling with a grouping restriction in <code>vtreat</code>.</p>
<p>For this example, we will use the <code>Theosph</code> dataset: data from an experiment on the pharmacokinetics of theophylline. We will demonstrate the desired effects of <em>y</em>-stratification while also respecting a grouping constraint.</p>
<div id="the-data" class="section level2">
<h2 class="hasAnchor">
<a href="#the-data" class="anchor"></a>The Data</h2>
<p>First, let’s look at the data.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># panel data for concentration in multiple subjects </span>
<span class="va">d</span> <span class="op">&lt;-</span> <span class="fu">datasets</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/r/datasets/Theoph.html">Theoph</a></span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span></code></pre></div>
<pre><code>##   Subject   Wt Dose Time  conc
## 1       1 79.6 4.02 0.00  0.74
## 2       1 79.6 4.02 0.25  2.84
## 3       1 79.6 4.02 0.57  6.57
## 4       1 79.6 4.02 1.12 10.50
## 5       1 79.6 4.02 2.02  9.66
## 6       1 79.6 4.02 3.82  8.58</code></pre>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span></code></pre></div>
<pre><code>##     Subject         Wt             Dose            Time             conc       
##  6      :11   Min.   :54.60   Min.   :3.100   Min.   : 0.000   Min.   : 0.000  
##  7      :11   1st Qu.:63.58   1st Qu.:4.305   1st Qu.: 0.595   1st Qu.: 2.877  
##  8      :11   Median :70.50   Median :4.530   Median : 3.530   Median : 5.275  
##  11     :11   Mean   :69.58   Mean   :4.626   Mean   : 5.895   Mean   : 4.960  
##  3      :11   3rd Qu.:74.42   3rd Qu.:5.037   3rd Qu.: 9.000   3rd Qu.: 7.140  
##  2      :11   Max.   :86.40   Max.   :5.860   Max.   :24.650   Max.   :11.400  
##  (Other):66</code></pre>
<p>We have twelve subjects, who each received a dose of the anti-asthma drug theophylline. The theophylline concentration in the patients’ blood was then measured at eleven points during the next 25 hours. Most of the patients got about the same dose, although the dose information reported in the dataset is normalized by weight.</p>
</div>
<div id="partitioning-the-data-for-modeling" class="section level2">
<h2 class="hasAnchor">
<a href="#partitioning-the-data-for-modeling" class="anchor"></a>Partitioning the Data for Modeling</h2>
<p>Suppose we wanted to fit a model to analyze how a patient’s weight affects how theophylline is metabolized, and validate that model with three-fold cross-validation. It would be important that all readings from a given patient stay in the same fold. We might also want the population in each fold to have similar distributions of theophylline concentrations curves.</p>
<p>Recall that the goal of <em>y</em>-stratification is to insure that all samples from the data have as close to identical <em>y</em> distributions as possible. This becomes more difficult when we also have to obey a grouping constraint.</p>
<p>Let’s look at three ways of splitting the data into folds. First, we will split the data arbitrarily into three groups, using the modulo of the Subject id to do the splitting.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># a somewhat arbitrary split of patients</span>
<span class="va">subnum</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">Subject</span><span class="op">)</span><span class="op">)</span>
<span class="va">d</span><span class="op">$</span><span class="va">modSplit</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">subnum</span> <span class="op">%%</span> <span class="fl">3</span><span class="op">)</span></code></pre></div>
<p>We can verify that this split preserves groups, by looking at the table of subject observations in each fold. Each subject should only appear in a single fold.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span>Subject<span class="op">=</span><span class="va">d</span><span class="op">$</span><span class="va">Subject</span>, groupid<span class="op">=</span><span class="va">d</span><span class="op">$</span><span class="va">modSplit</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##        groupid
## Subject  0  1  2
##      6  11  0  0
##      7   0 11  0
##      8   0  0 11
##      11  0  0 11
##      3  11  0  0
##      2   0  0 11
##      4   0 11  0
##      9  11  0  0
##      12 11  0  0
##      10  0 11  0
##      1   0 11  0
##      5   0  0 11</code></pre>
<p>Now let’s try the standard <em>y</em> stratification in <code>vtreat</code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># stratify by outcome only</span>
<span class="co"># forces concentration to be equivalent</span>
<span class="va">pStrat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/kWayStratifiedY.html">kWayStratifiedY</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span>,<span class="fl">3</span>,<span class="va">d</span>,<span class="va">d</span><span class="op">$</span><span class="va">conc</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">pStrat</span>, <span class="st">"splitmethod"</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "kwaycrossystratified"</code></pre>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">d</span><span class="op">$</span><span class="va">stratSplit</span> <span class="op">&lt;-</span> <span class="fu">vtreat</span><span class="fu">::</span><span class="fu"><a href="../reference/getSplitPlanAppLabels.html">getSplitPlanAppLabels</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span>,<span class="va">pStrat</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span>Subject<span class="op">=</span><span class="va">d</span><span class="op">$</span><span class="va">Subject</span>, groupid<span class="op">=</span><span class="va">d</span><span class="op">$</span><span class="va">stratSplit</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##        groupid
## Subject 1 2 3
##      6  6 2 3
##      7  2 8 1
##      8  2 3 6
##      11 4 3 4
##      3  3 4 4
##      2  4 3 4
##      4  5 5 1
##      9  6 3 2
##      12 3 4 4
##      10 1 2 8
##      1  6 2 3
##      5  2 5 4</code></pre>
<p>We can see this partition didn’t preserve the <code>Subject</code> grouping.</p>
<p>Finally, we can try <code>vtreat</code>’s group-preserving split, which also tries to <em>y</em>-stratify as much as possible (by stratifying on the mean <em>y</em> observation from each group).</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># stratify by patient and outcome</span>
<span class="co"># allows concentration to vary amoung individual patients</span>
<span class="va">splitter</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/makekWayCrossValidationGroupedByColumn.html">makekWayCrossValidationGroupedByColumn</a></span><span class="op">(</span><span class="st">'Subject'</span><span class="op">)</span>
<span class="va">split</span> <span class="op">&lt;-</span> <span class="fu">splitter</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span>,<span class="fl">3</span>,<span class="va">d</span>,<span class="va">d</span><span class="op">$</span><span class="va">conc</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">split</span>, <span class="st">"splitmethod"</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "kwaycrossystratifiedgrouped"</code></pre>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">d</span><span class="op">$</span><span class="va">subjectSplit</span> <span class="op">&lt;-</span> <span class="fu">vtreat</span><span class="fu">::</span><span class="fu"><a href="../reference/getSplitPlanAppLabels.html">getSplitPlanAppLabels</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span>,<span class="va">split</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span>Subject<span class="op">=</span><span class="va">d</span><span class="op">$</span><span class="va">Subject</span>, groupid<span class="op">=</span><span class="va">d</span><span class="op">$</span><span class="va">subjectSplit</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##        groupid
## Subject  1  2  3
##      6   0  0 11
##      7  11  0  0
##      8   0 11  0
##      11  0  0 11
##      3   0 11  0
##      2  11  0  0
##      4   0  0 11
##      9   0 11  0
##      12 11  0  0
##      10 11  0  0
##      1   0 11  0
##      5   0  0 11</code></pre>
<p>This is again a subject-preserving partition.</p>
<p>We can compare the mean theophylline concentration and the average pharmacokinetic profile for each fold, for both of the subject-preserving partitions. We see that the stratification reduces some of the variation between folds.</p>
<div id="arbitrary-partition" class="section level3">
<h3 class="hasAnchor">
<a href="#arbitrary-partition" class="anchor"></a>Arbitrary Partition</h3>
<pre><code>## [1] "Arbitrary grouping"
## [1] "Group means:"
##        0        1        2 
## 4.728864 5.305227 4.847273 
## [1] "Standard deviation of group means: 0.304395061237506"</code></pre>
</div>
<div id="group-preserving-y-stratified-partition" class="section level3">
<h3 class="hasAnchor">
<a href="#group-preserving-y-stratified-partition" class="anchor"></a>Group-preserving, <em>y</em>-stratified Partition</h3>
<pre><code>## [1] "Group by patient, stratify on y"
## [1] "Group means:"
##        1        2        3 
## 5.018864 5.172727 4.689773 
## [1] "Standard deviation of group means: 0.246718442094266"</code></pre>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by John Mount, Nina Zumel.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
