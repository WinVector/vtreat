<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>vtreat scale mode • vtreat</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="vtreat scale mode">
<meta property="og:description" content="vtreat">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">vtreat</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.6.4</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/vtreat.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/MultiClassVtreat.html">Multi Class vtreat</a>
    </li>
    <li>
      <a href="../articles/SavingTreamentPlans.html">Saving Treatment Plans</a>
    </li>
    <li>
      <a href="../articles/VariableImportance.html">vtreat Variable Importance</a>
    </li>
    <li>
      <a href="../articles/vtreatCrossFrames.html">vtreat cross frames</a>
    </li>
    <li>
      <a href="../articles/vtreatGrouping.html">vtreat grouping example</a>
    </li>
    <li>
      <a href="../articles/vtreatOverfit.html">vtreat overfit</a>
    </li>
    <li>
      <a href="../articles/vtreatRareLevels.html">vtreat Rare Levels</a>
    </li>
    <li>
      <a href="../articles/vtreatScaleMode.html">vtreat scale mode</a>
    </li>
    <li>
      <a href="../articles/vtreatSignificance.html">vtreat significance</a>
    </li>
    <li>
      <a href="../articles/vtreatSplitting.html">vtreat data splitting</a>
    </li>
    <li>
      <a href="../articles/vtreatVariableTypes.html">Variable Types</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://win-vector.com/" class="external-link">Sponsor: Win-Vector LLC</a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>vtreat scale mode</h1>
                        <h4 data-toc-skip class="author">Win-Vector
LLC</h4>
            
            <h4 data-toc-skip class="date">2023-08-19</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/WinVector/vtreat/blob/HEAD/vignettes/vtreatScaleMode.Rmd" class="external-link"><code>vignettes/vtreatScaleMode.Rmd</code></a></small>
      <div class="hidden name"><code>vtreatScaleMode.Rmd</code></div>

    </div>

    
    
<p><code>vtreat::prepare(scale=TRUE)</code> is a variation of
<code><a href="../reference/prepare.html">vtreat::prepare()</a></code> intended to prepare data frames so all
the derived input or independent (<code>x</code>) variables are fully in
outcome or dependent variable (<code>y</code>) units. This is in the
sense of a linear regression for numeric <code>y</code>’s
(<code><a href="../reference/designTreatmentsN.html">vtreat::designTreatmentsN</a></code> and
<code><a href="../reference/mkCrossFrameNExperiment.html">vtreat::mkCrossFrameNExperiment</a></code>).<br>
For classification problems (or categorical <code>y</code>’s) as of
version <code>0.5.26</code> and newer (available <a href="https://github.com/WinVector/vtreat" class="external-link">here</a>) scaling is
established through a a logistic regression <a href="https://github.com/WinVector/Examples/blob/master/PCR/YAwarePCAclassification.md" class="external-link">“in
link units”</a> or as 0/1 indicators depending on the setting of the
<code>catScaling</code> argument in
<code><a href="../reference/designTreatmentsC.html">vtreat::designTreatmentsC</a></code> or
<code><a href="../reference/mkCrossFrameNExperiment.html">vtreat::mkCrossFrameNExperiment</a></code>. Prior to this version
classification the scaling calculation (and only the scaling
calculation) was always handled as a linear regression against a 0/1
<code>y</code>-indicator. <code>catScaling=FALSE</code> can be a bit
faster as the underlying regression can be a bit quicker than a logistic
regression.</p>
<p>This is the appropriate preparation before a geometry/metric
sensitive modeling step such as principal components analysis or
clustering (such as k-means clustering).</p>
<p>Normally (with <code>vtreat::prepare(scale=FALSE)</code>) vtreat
passes through a number of variables with minimal alteration (cleaned
numeric), builds 0/1 indicator variables for various conditions
(categorical levels, presence of NAs, and so on), and builds some “in
y-units” variables (catN, catB) that are in fact sub-models. With
<code>vtreat::prepare(scale=TRUE)</code> all of these numeric variables
are then re-processed to have mean zero, and slope 1 (when possible)
when appropriately regressed against the y-variable.</p>
<p>This is easiest to illustrate with a concrete example.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/WinVector/vtreat/" class="external-link">'vtreat'</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Loading required package: wrapr</span></span></code></pre>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dTrainC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'a'</span>,<span class="st">'a'</span>,<span class="st">'a'</span>,<span class="st">'b'</span>,<span class="st">'b'</span>,<span class="cn">NA</span><span class="op">)</span>,</span>
<span>                      y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">FALSE</span>,<span class="cn">FALSE</span>,<span class="cn">TRUE</span>,<span class="cn">FALSE</span>,<span class="cn">TRUE</span>,<span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">treatmentsC</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/designTreatmentsC.html">designTreatmentsC</a></span><span class="op">(</span><span class="va">dTrainC</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">dTrainC</span><span class="op">)</span>,<span class="st">'y'</span>,<span class="cn">TRUE</span>,</span>
<span>                                 catScaling<span class="op">=</span><span class="cn">FALSE</span>,</span>
<span>                                 verbose<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">dTrainCTreatedUnscaled</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare.html">prepare</a></span><span class="op">(</span><span class="va">treatmentsC</span>,<span class="va">dTrainC</span>,pruneSig<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span>,scale<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning in prepare.treatmentplan(treatmentsC, dTrainC, pruneSig = c(), scale =</span></span>
<span><span class="co">## FALSE): possibly called prepare() on same data frame as</span></span>
<span><span class="co">## designTreatments*()/mkCrossFrame*Experiment(), this can lead to over-fit.  To</span></span>
<span><span class="co">## avoid this, please use mkCrossFrame*Experiment$crossFrame.</span></span></code></pre>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dTrainCTreatedScaled</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare.html">prepare</a></span><span class="op">(</span><span class="va">treatmentsC</span>,<span class="va">dTrainC</span>,pruneSig<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span>,scale<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning in prepare.treatmentplan(treatmentsC, dTrainC, pruneSig = c(), scale =</span></span>
<span><span class="co">## TRUE): possibly called prepare() on same data frame as</span></span>
<span><span class="co">## designTreatments*()/mkCrossFrame*Experiment(), this can lead to over-fit.  To</span></span>
<span><span class="co">## avoid this, please use mkCrossFrame*Experiment$crossFrame.</span></span></code></pre>
<p>Note we have set <code>catScaling=FALSE</code> to ask that we treat
<code>y</code> as a 0/1 indicator and scale using linear regression. The
standard vtreat treated frame converts the original data from this:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">dTrainC</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##      x     y</span></span>
<span><span class="co">## 1    a FALSE</span></span>
<span><span class="co">## 2    a FALSE</span></span>
<span><span class="co">## 3    a  TRUE</span></span>
<span><span class="co">## 4    b FALSE</span></span>
<span><span class="co">## 5    b  TRUE</span></span>
<span><span class="co">## 6 &lt;NA&gt;  TRUE</span></span></code></pre>
<p>into this:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">dTrainCTreatedUnscaled</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##      x_catP     x_catB x_lev_NA x_lev_x_a x_lev_x_b     y</span></span>
<span><span class="co">## 1 0.5000000 -0.6930972        0         1         0 FALSE</span></span>
<span><span class="co">## 2 0.5000000 -0.6930972        0         1         0 FALSE</span></span>
<span><span class="co">## 3 0.5000000 -0.6930972        0         1         0  TRUE</span></span>
<span><span class="co">## 4 0.3333333  0.0000000        0         0         1 FALSE</span></span>
<span><span class="co">## 5 0.3333333  0.0000000        0         0         1  TRUE</span></span>
<span><span class="co">## 6 0.1666667  9.2104404        1         0         0  TRUE</span></span></code></pre>
<p>This is the “standard way” to run vtreat – with the exception that
for this example we set <code>pruneSig</code> to <code>NULL</code> to
suppress variable pruning, instead of setting it to a value in the
interval <code>(0,1)</code>. The principle is: vtreat inflicts the
minimal possible alterations on the data, leaving as much as possible to
the downstream machine learning code. This does turn out to already be a
lot of alteration. Mostly vtreat is taking only steps that are unsafe to
leave for later: re-encoding of large categoricals, re-coding of
aberrant values, and bulk pruning of variables.</p>
<p>However some procedures, in particular principal components analysis
or geometric clustering, assume all of the columns have been fully
transformed. The usual assumption (“more honored in the breach than the
observance”) is that the columns are centered (mean zero) and scaled.
The non y-aware meaning of “scaled” is unit variance. However, vtreat is
designed to emphasize y-aware processing and we feel the y-aware sense
of scaling should be: unit slope when regressed against y. If you want
standard scaling you can use the standard frame produced by vtreat and
scale it yourself. If you want vtreat style y-aware scaling you (which
we strongly think is the right thing to do) you can use
<code>vtreat::prepare(scale=TRUE)</code> which produces a frame that
looks like the following:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">dTrainCTreatedScaled</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   x_catP      x_catB x_lev_NA  x_lev_x_a     x_lev_x_b     y</span></span>
<span><span class="co">## 1   -0.2 -0.11976374     -0.1 -0.1666667  4.807407e-17 FALSE</span></span>
<span><span class="co">## 2   -0.2 -0.11976374     -0.1 -0.1666667  4.807407e-17 FALSE</span></span>
<span><span class="co">## 3   -0.2 -0.11976374     -0.1 -0.1666667  4.807407e-17  TRUE</span></span>
<span><span class="co">## 4    0.1 -0.07564865     -0.1  0.1666667 -9.614813e-17 FALSE</span></span>
<span><span class="co">## 5    0.1 -0.07564865     -0.1  0.1666667 -9.614813e-17  TRUE</span></span>
<span><span class="co">## 6    0.4  0.51058851      0.5  0.1666667  4.807407e-17  TRUE</span></span></code></pre>
<p>First we can check the claims. Are the variables mean-zero and slope
1 when regressed against y?</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">slopeFrame</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>varName <span class="op">=</span> <span class="va">treatmentsC</span><span class="op">$</span><span class="va">scoreFrame</span><span class="op">$</span><span class="va">varName</span>,</span>
<span>                         stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">slopeFrame</span><span class="op">$</span><span class="va">mean</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">dTrainCTreatedScaled</span><span class="op">[</span>, <span class="va">slopeFrame</span><span class="op">$</span><span class="va">varName</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>, <span class="va">mean</span>,</span>
<span>         <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">slopeFrame</span><span class="op">$</span><span class="va">slope</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">slopeFrame</span><span class="op">$</span><span class="va">varName</span>,</span>
<span>                           <span class="kw">function</span><span class="op">(</span><span class="va">c</span><span class="op">)</span> <span class="op">{</span></span>
<span>                             <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">'y'</span>, <span class="va">c</span>, sep <span class="op">=</span> <span class="st">'~'</span><span class="op">)</span>,</span>
<span>                                data <span class="op">=</span> <span class="va">dTrainCTreatedScaled</span><span class="op">)</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span>
<span>                           <span class="op">}</span>,</span>
<span>                           <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">slopeFrame</span><span class="op">$</span><span class="va">sig</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">slopeFrame</span><span class="op">$</span><span class="va">varName</span>,</span>
<span>                         <span class="kw">function</span><span class="op">(</span><span class="va">c</span><span class="op">)</span> <span class="op">{</span></span>
<span>                           <span class="va">treatmentsC</span><span class="op">$</span><span class="va">scoreFrame</span><span class="op">[</span><span class="va">treatmentsC</span><span class="op">$</span><span class="va">scoreFrame</span><span class="op">$</span><span class="va">varName</span> <span class="op">==</span> <span class="va">c</span>, <span class="st">'sig'</span><span class="op">]</span></span>
<span>                         <span class="op">}</span>,</span>
<span>                         <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">slopeFrame</span><span class="op">$</span><span class="va">badSlope</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">slopeFrame</span><span class="op">$</span><span class="va">slope</span><span class="op">)</span>, <span class="cn">TRUE</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">slopeFrame</span><span class="op">$</span><span class="va">slope</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1.e-8</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">slopeFrame</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##     varName          mean slope       sig badSlope</span></span>
<span><span class="co">## 1    x_catP  1.850372e-17     1 0.3289524    FALSE</span></span>
<span><span class="co">## 2    x_catB -1.156482e-17     1 0.3161341    FALSE</span></span>
<span><span class="co">## 3  x_lev_NA -6.938894e-18     1 0.2076623    FALSE</span></span>
<span><span class="co">## 4 x_lev_x_a -2.775558e-17     1 0.4097258    FALSE</span></span>
<span><span class="co">## 5 x_lev_x_b  4.108149e-33     0 1.0000000     TRUE</span></span></code></pre>
<p>The above claims are true with the exception of the derived variable
<code>x_lev_x.b</code>. This is because the outcome variable
<code>y</code> has identical distribution when the original variable
<code>x==‘b’</code> and when <code>x!=‘b’</code> (on half the time in
both cases). This means <code>y</code> is perfectly independent of
<code>x==‘b’</code> and the regression slope must be zero (thus, cannot
be 1). vtreat now treats this as needing to scale by a multiplicative
factor of zero. Note also that the significance level associated with
<code>x_lev_x.b</code> is large, making this variable easy to prune. The
<code>varMoves</code> and significance facts in
<code>treatmentsC$scoreFrame</code> are about the un-scaled frame (where
<code>x_lev_x.b</code> does in fact move).</p>
<p>For a good discussion of the application of <em>y</em>-aware scaling
to Principal Components Analysis please see <a href="https://win-vector.com/2016/05/23/pcr_part2_yaware/" class="external-link">here</a>.</p>
<p>Previous versions of vtreat (0.5.22 and earlier) would copy variables
that could not be sensibly scaled into the treated frame unaltered. This
was considered the “most faithful” thing to do. However we now feel that
this practice was not safe for many downstream procedures, such as
principal components analysis and geometric clustering.</p>
<div class="section level3">
<h3 id="categorical-outcome-mode-catscalingtrue">Categorical outcome mode “catScaling=TRUE”<a class="anchor" aria-label="anchor" href="#categorical-outcome-mode-catscalingtrue"></a>
</h3>
<p>As of version <code>0.5.26</code> <code>vtreat</code> also supports a
“scaling mode for categorical outcomes.” In this mode scaling is
performed using the coefficient of a logistic regression fit on a
categorical instead of the coefficient of a linear fit (with the outcome
encoded as a zero/one indicator).</p>
<p>The idea is with this mode on we are scaling as a logistic regression
would- so we are in logistic regression “link space” (where logistic
regression assume effects are additive). The mode may be well suited for
principal components analysis or principal components regression where
the target variable is a categorical (i.e. classification tasks).</p>
<p>To ensure this effect we set the argument
<code>catScaling=TRUE</code> in <code><a href="../reference/designTreatmentsC.html">vtreat::designTreatmentsC</a></code>
or <code><a href="../reference/mkCrossFrameCExperiment.html">vtreat::mkCrossFrameCExperiment</a></code>. WE demonstrate this
below.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">treatmentsC2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/designTreatmentsC.html">designTreatmentsC</a></span><span class="op">(</span><span class="va">dTrainC</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">dTrainC</span><span class="op">)</span>,<span class="st">'y'</span>,<span class="cn">TRUE</span>,</span>
<span>                                  catScaling<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>                                  verbose<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">dTrainCTreatedScaled2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare.html">prepare</a></span><span class="op">(</span><span class="va">treatmentsC2</span>,<span class="va">dTrainC</span>,pruneSig<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span>,scale<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning in prepare.treatmentplan(treatmentsC2, dTrainC, pruneSig = c(), :</span></span>
<span><span class="co">## possibly called prepare() on same data frame as</span></span>
<span><span class="co">## designTreatments*()/mkCrossFrame*Experiment(), this can lead to over-fit.  To</span></span>
<span><span class="co">## avoid this, please use mkCrossFrame*Experiment$crossFrame.</span></span></code></pre>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">dTrainCTreatedScaled2</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##       x_catP    x_catB  x_lev_NA  x_lev_x_a x_lev_x_b     y</span></span>
<span><span class="co">## 1 -0.9396225 -1.894112 -3.161922 -0.6931472         0 FALSE</span></span>
<span><span class="co">## 2 -0.9396225 -1.894112 -3.161922 -0.6931472         0 FALSE</span></span>
<span><span class="co">## 3 -0.9396225 -1.894112 -3.161922 -0.6931472         0  TRUE</span></span>
<span><span class="co">## 4  0.4698112 -1.196414 -3.161922  0.6931472         0 FALSE</span></span>
<span><span class="co">## 5  0.4698112 -1.196414 -3.161922  0.6931472         0  TRUE</span></span>
<span><span class="co">## 6  1.8792449  8.075166 15.809611  0.6931472         0  TRUE</span></span></code></pre>
<p>Notice the new scaled frame is in a different scale than the original
scaled frame. It likely is a function of the problem domain which
scaling is more appropriate or useful.</p>
<p>The new scaled columns are again mean-0 (so they are not exactly the
logistic link values, which may not have been so shifted). The new
scaled columns do not necessarily have linear model slope 1 as the
original scaled columns did as we see below:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">dTrainCTreatedScaled2</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##        x_catP        x_catB      x_lev_NA     x_lev_x_a     x_lev_x_b </span></span>
<span><span class="co">##  3.700743e-16 -3.700743e-17 -2.220446e-16  1.110223e-16  0.000000e+00 </span></span>
<span><span class="co">##             y </span></span>
<span><span class="co">##  5.000000e-01</span></span></code></pre>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">x_lev_NA</span>,data<span class="op">=</span><span class="va">dTrainCTreatedScaled</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Call:</span></span>
<span><span class="co">## lm(formula = y ~ x_lev_NA, data = dTrainCTreatedScaled)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Coefficients:</span></span>
<span><span class="co">## (Intercept)     x_lev_NA  </span></span>
<span><span class="co">##         0.5          1.0</span></span></code></pre>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">x_lev_NA</span>,data<span class="op">=</span><span class="va">dTrainCTreatedScaled2</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Call:</span></span>
<span><span class="co">## lm(formula = y ~ x_lev_NA, data = dTrainCTreatedScaled2)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Coefficients:</span></span>
<span><span class="co">## (Intercept)     x_lev_NA  </span></span>
<span><span class="co">##     0.50000      0.03163</span></span></code></pre>
<p>The new scaled columns, however are in good logistic link units.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">slopeFrame</span><span class="op">$</span><span class="va">varName</span>,</span>
<span>                           <span class="kw">function</span><span class="op">(</span><span class="va">c</span><span class="op">)</span> <span class="op">{</span></span>
<span>                             <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">'y'</span>, <span class="va">c</span>, sep <span class="op">=</span> <span class="st">'~'</span><span class="op">)</span>,family<span class="op">=</span><span class="va">binomial</span>,</span>
<span>                                data <span class="op">=</span> <span class="va">dTrainCTreatedScaled2</span><span class="op">)</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span>
<span>                           <span class="op">}</span>,</span>
<span>                           <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    x_catP    x_catB  x_lev_NA x_lev_x_a x_lev_x_b </span></span>
<span><span class="co">##         1         1         1         1        NA</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="pcapcr">PCA/PCR<a class="anchor" aria-label="anchor" href="#pcapcr"></a>
</h3>
<p>The intended applications of scale mode include preparing data for
metric sensitive applications such as KNN classification/regression and
Principal Components Analysis/Regression. Please see <a href="https://github.com/WinVector/Examples/tree/master/PCR" class="external-link">here</a>
for an article series describing such applications.</p>
<p>Overall the advice is to first use the following pattern:</p>
<ul>
<li>Significance prune incoming variables.</li>
<li>Use <em>y</em>-aware scaling.</li>
<li>Significance prune resulting latent variables.</li>
</ul>
<p>However, practitioners experienced in principal components analysis
may uncomfortable with the range of eigenvalues or singular values
returned by <em>y</em>-aware analysis. If a more familiar scale is
desired we suggest performing the <em>y</em>-aware scaling against an
additional scaled and centered <em>y</em> to try to get ranges closer
the traditional unit ranges. This can be achieved as shown below.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">235235</span><span class="op">)</span></span>
<span><span class="va">dTrainN</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x1<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>,</span>
<span>                      x2<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>,</span>
<span>                      x3<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>,</span>
<span>                      stringsAsFactors<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">dTrainN</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fl">1000</span><span class="op">*</span><span class="op">(</span><span class="va">dTrainN</span><span class="op">$</span><span class="va">x1</span> <span class="op">+</span> <span class="va">dTrainN</span><span class="op">$</span><span class="va">x2</span><span class="op">)</span></span>
<span><span class="va">cEraw</span> <span class="op">&lt;-</span> <span class="fu">vtreat</span><span class="fu">::</span><span class="fu"><a href="../reference/mkCrossFrameNExperiment.html">mkCrossFrameNExperiment</a></span><span class="op">(</span><span class="va">dTrainN</span>,</span>
<span>                                         <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'x1'</span>,<span class="st">'x2'</span>,<span class="st">'x3'</span><span class="op">)</span>,<span class="st">'y'</span>,</span>
<span>                                         scale<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "vtreat 1.6.4 start initial treatment design Sat Aug 19 11:38:45 2023"</span></span>
<span><span class="co">## [1] " start cross frame work Sat Aug 19 11:38:45 2023"</span></span>
<span><span class="co">## [1] " vtreat::mkCrossFrameNExperiment done Sat Aug 19 11:38:45 2023"</span></span></code></pre>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">newvars</span> <span class="op">&lt;-</span> <span class="va">cEraw</span><span class="op">$</span><span class="va">treatments</span><span class="op">$</span><span class="va">scoreFrame</span><span class="op">$</span><span class="va">varName</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">newvars</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "x1" "x2" "x3"</span></span></code></pre>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dM1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">cEraw</span><span class="op">$</span><span class="va">crossFrame</span><span class="op">[</span>, <span class="va">newvars</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">pCraw</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/prcomp.html" class="external-link">prcomp</a></span><span class="op">(</span><span class="va">dM1</span>,</span>
<span>                       scale.<span class="op">=</span><span class="cn">FALSE</span>,center<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">pCraw</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Standard deviations (1, .., p=3):</span></span>
<span><span class="co">## [1] 1160.3144 1057.6874  101.1756</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Rotation (n x k) = (3 x 3):</span></span>
<span><span class="co">##              PC1          PC2           PC3</span></span>
<span><span class="co">## x1  0.9653602255 -0.260919781 -0.0007092447</span></span>
<span><span class="co">## x2  0.2609205097  0.965359437  0.0012824611</span></span>
<span><span class="co">## x3 -0.0003500566  0.001423093 -0.9999989261</span></span></code></pre>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dTrainN</span><span class="op">$</span><span class="va">yScaled</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">dTrainN</span><span class="op">$</span><span class="va">y</span>,center<span class="op">=</span><span class="cn">TRUE</span>,scale<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">cEscaled</span> <span class="op">&lt;-</span> <span class="fu">vtreat</span><span class="fu">::</span><span class="fu"><a href="../reference/mkCrossFrameNExperiment.html">mkCrossFrameNExperiment</a></span><span class="op">(</span><span class="va">dTrainN</span>,</span>
<span>                                            <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'x1'</span>,<span class="st">'x2'</span>,<span class="st">'x3'</span><span class="op">)</span>,<span class="st">'yScaled'</span>,</span>
<span>                                            scale<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "vtreat 1.6.4 start initial treatment design Sat Aug 19 11:38:45 2023"</span></span>
<span><span class="co">## [1] " start cross frame work Sat Aug 19 11:38:45 2023"</span></span>
<span><span class="co">## [1] " vtreat::mkCrossFrameNExperiment done Sat Aug 19 11:38:45 2023"</span></span></code></pre>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">newvars_s</span> <span class="op">&lt;-</span> <span class="va">cEscaled</span><span class="op">$</span><span class="va">treatments</span><span class="op">$</span><span class="va">scoreFrame</span><span class="op">$</span><span class="va">varName</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">newvars_s</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "x1" "x2" "x3"</span></span></code></pre>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dM2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">cEscaled</span><span class="op">$</span><span class="va">crossFrame</span><span class="op">[</span>, <span class="va">newvars_s</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">pCscaled</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/prcomp.html" class="external-link">prcomp</a></span><span class="op">(</span><span class="va">dM2</span>,</span>
<span>                          scale.<span class="op">=</span><span class="cn">FALSE</span>,center<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">pCscaled</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Standard deviations (1, .., p=3):</span></span>
<span><span class="co">## [1] 0.7866757 0.6880818 0.1097586</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Rotation (n x k) = (3 x 3):</span></span>
<span><span class="co">##           PC1         PC2        PC3</span></span>
<span><span class="co">## x1  0.9700658 -0.24208741 0.01913148</span></span>
<span><span class="co">## x2  0.2417583  0.97016953 0.01800061</span></span>
<span><span class="co">## x3 -0.0229185 -0.01283658 0.99965492</span></span></code></pre>
<p>Notice the second application of <code><a href="https://rdrr.io/r/stats/prcomp.html" class="external-link">stats::prcomp</a></code> has more
standard scaling of the reported standard deviations (though we still do
not advise choosing latent variables based on mere comparisons to unit
magnitude).</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by John Mount, Nina Zumel.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
